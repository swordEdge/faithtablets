(function(){var context=this;(function(){(function(){var slice=[].slice;this.ActionCable={INTERNAL:{message_types:{welcome:"welcome",ping:"ping",confirmation:"confirm_subscription",rejection:"reject_subscription"},default_mount_path:"/cable",protocols:["actioncable-v1-json","actioncable-unsupported"]},WebSocket:window.WebSocket,logger:window.console,createConsumer:function(url){var ref;return null==url&&(url=null!=(ref=this.getConfig("url"))?ref:this.INTERNAL.default_mount_path),new ActionCable.Consumer(this.createWebSocketURL(url))},getConfig:function(name){var element;return null!=(element=document.head.querySelector("meta[name='action-cable-"+name+"']"))?element.getAttribute("content"):void 0},createWebSocketURL:function(url){var a;return url&&!/^wss?:/i.test(url)?((a=document.createElement("a")).href=url,a.href=a.href,a.protocol=a.protocol.replace("http","ws"),a.href):url},startDebugging:function(){return this.debugging=!0},stopDebugging:function(){return this.debugging=null},log:function(){var messages,ref;if(messages=1<=arguments.length?slice.call(arguments,0):[],this.debugging)return messages.push(Date.now()),(ref=this.logger).log.apply(ref,["[ActionCable]"].concat(slice.call(messages)))}}}).call(this)}).call(context);var ActionCable=context.ActionCable;(function(){(function(){var bind=function(fn,me){return function(){return fn.apply(me,arguments)}};ActionCable.ConnectionMonitor=function(){function ConnectionMonitor(connection){this.connection=connection,this.visibilityDidChange=bind(this.visibilityDidChange,this),this.reconnectAttempts=0}var clamp,now,secondsSince;return ConnectionMonitor.pollInterval={min:3,max:30},ConnectionMonitor.staleThreshold=6,ConnectionMonitor.prototype.start=function(){if(!this.isRunning())return this.startedAt=now(),delete this.stoppedAt,this.startPolling(),document.addEventListener("visibilitychange",this.visibilityDidChange),ActionCable.log("ConnectionMonitor started. pollInterval = "+this.getPollInterval()+" ms")},ConnectionMonitor.prototype.stop=function(){if(this.isRunning())return this.stoppedAt=now(),this.stopPolling(),document.removeEventListener("visibilitychange",this.visibilityDidChange),ActionCable.log("ConnectionMonitor stopped")},ConnectionMonitor.prototype.isRunning=function(){return null!=this.startedAt&&null==this.stoppedAt},ConnectionMonitor.prototype.recordPing=function(){return this.pingedAt=now()},ConnectionMonitor.prototype.recordConnect=function(){return this.reconnectAttempts=0,this.recordPing(),delete this.disconnectedAt,ActionCable.log("ConnectionMonitor recorded connect")},ConnectionMonitor.prototype.recordDisconnect=function(){return this.disconnectedAt=now(),ActionCable.log("ConnectionMonitor recorded disconnect")},ConnectionMonitor.prototype.startPolling=function(){return this.stopPolling(),this.poll()},ConnectionMonitor.prototype.stopPolling=function(){return clearTimeout(this.pollTimeout)},ConnectionMonitor.prototype.poll=function(){return this.pollTimeout=setTimeout((_this=this,function(){return _this.reconnectIfStale(),_this.poll()}),this.getPollInterval());var _this},ConnectionMonitor.prototype.getPollInterval=function(){var interval,max,min,ref;return min=(ref=this.constructor.pollInterval).min,max=ref.max,interval=5*Math.log(this.reconnectAttempts+1),Math.round(1e3*clamp(interval,min,max))},ConnectionMonitor.prototype.reconnectIfStale=function(){if(this.connectionIsStale())return ActionCable.log("ConnectionMonitor detected stale connection. reconnectAttempts = "+this.reconnectAttempts+", pollInterval = "+this.getPollInterval()+" ms, time disconnected = "+secondsSince(this.disconnectedAt)+" s, stale threshold = "+this.constructor.staleThreshold+" s"),this.reconnectAttempts++,this.disconnectedRecently()?ActionCable.log("ConnectionMonitor skipping reopening recent disconnect"):(ActionCable.log("ConnectionMonitor reopening"),this.connection.reopen())},ConnectionMonitor.prototype.connectionIsStale=function(){var ref;return secondsSince(null!=(ref=this.pingedAt)?ref:this.startedAt)>this.constructor.staleThreshold},ConnectionMonitor.prototype.disconnectedRecently=function(){return this.disconnectedAt&&secondsSince(this.disconnectedAt)<this.constructor.staleThreshold},ConnectionMonitor.prototype.visibilityDidChange=function(){if("visible"===document.visibilityState)return setTimeout((_this=this,function(){if(_this.connectionIsStale()||!_this.connection.isOpen())return ActionCable.log("ConnectionMonitor reopening stale connection on visibilitychange. visbilityState = "+document.visibilityState),_this.connection.reopen()}),200);var _this},now=function(){return(new Date).getTime()},secondsSince=function(time){return(now()-time)/1e3},clamp=function(number,min,max){return Math.max(min,Math.min(max,number))},ConnectionMonitor}()}).call(this),function(){var i,message_types,protocols,ref,supportedProtocols,slice=[].slice,bind=function(fn,me){return function(){return fn.apply(me,arguments)}},indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++)if(i in this&&this[i]===item)return i;return-1};ref=ActionCable.INTERNAL,message_types=ref.message_types,protocols=ref.protocols,supportedProtocols=2<=protocols.length?slice.call(protocols,0,i=protocols.length-1):(i=0,[]),protocols[i++],ActionCable.Connection=function(){function Connection(consumer){this.consumer=consumer,this.open=bind(this.open,this),this.subscriptions=this.consumer.subscriptions,this.monitor=new ActionCable.ConnectionMonitor(this),this.disconnected=!0}return Connection.reopenDelay=500,Connection.prototype.send=function(data){return!!this.isOpen()&&(this.webSocket.send(JSON.stringify(data)),!0)},Connection.prototype.open=function(){return this.isActive()?(ActionCable.log("Attempted to open WebSocket, but existing socket is "+this.getState()),!1):(ActionCable.log("Opening WebSocket, current state is "+this.getState()+", subprotocols: "+protocols),null!=this.webSocket&&this.uninstallEventHandlers(),this.webSocket=new ActionCable.WebSocket(this.consumer.url,protocols),this.installEventHandlers(),this.monitor.start(),!0)},Connection.prototype.close=function(arg){var ref1;if((null!=arg?arg:{allowReconnect:!0}).allowReconnect||this.monitor.stop(),this.isActive())return null!=(ref1=this.webSocket)?ref1.close():void 0},Connection.prototype.reopen=function(){var error;if(ActionCable.log("Reopening WebSocket, current state is "+this.getState()),!this.isActive())return this.open();try{return this.close()}catch(error1){return error=error1,ActionCable.log("Failed to reopen WebSocket",error)}finally{ActionCable.log("Reopening WebSocket in "+this.constructor.reopenDelay+"ms"),setTimeout(this.open,this.constructor.reopenDelay)}},Connection.prototype.getProtocol=function(){var ref1;return null!=(ref1=this.webSocket)?ref1.protocol:void 0},Connection.prototype.isOpen=function(){return this.isState("open")},Connection.prototype.isActive=function(){return this.isState("open","connecting")},Connection.prototype.isProtocolSupported=function(){var ref1;return ref1=this.getProtocol(),0<=indexOf.call(supportedProtocols,ref1)},Connection.prototype.isState=function(){var ref1,states;return states=1<=arguments.length?slice.call(arguments,0):[],ref1=this.getState(),0<=indexOf.call(states,ref1)},Connection.prototype.getState=function(){var ref1,state;for(state in WebSocket)if(WebSocket[state]===(null!=(ref1=this.webSocket)?ref1.readyState:void 0))return state.toLowerCase();return null},Connection.prototype.installEventHandlers=function(){var eventName,handler;for(eventName in this.events)handler=this.events[eventName].bind(this),this.webSocket["on"+eventName]=handler},Connection.prototype.uninstallEventHandlers=function(){var eventName;for(eventName in this.events)this.webSocket["on"+eventName]=function(){}},Connection.prototype.events={message:function(event){var identifier,message,ref1;if(this.isProtocolSupported())switch(identifier=(ref1=JSON.parse(event.data)).identifier,message=ref1.message,ref1.type){case message_types.welcome:return this.monitor.recordConnect(),this.subscriptions.reload();case message_types.ping:return this.monitor.recordPing();case message_types.confirmation:return this.subscriptions.notify(identifier,"connected");case message_types.rejection:return this.subscriptions.reject(identifier);default:return this.subscriptions.notify(identifier,"received",message)}},open:function(){if(ActionCable.log("WebSocket onopen event, using '"+this.getProtocol()+"' subprotocol"),this.disconnected=!1,!this.isProtocolSupported())return ActionCable.log("Protocol is unsupported. Stopping monitor and disconnecting."),this.close({allowReconnect:!1})},close:function(){if(ActionCable.log("WebSocket onclose event"),!this.disconnected)return this.disconnected=!0,this.monitor.recordDisconnect(),this.subscriptions.notifyAll("disconnected",{willAttemptReconnect:this.monitor.isRunning()})},error:function(){return ActionCable.log("WebSocket onerror event")}},Connection}()}.call(this),function(){var slice=[].slice;ActionCable.Subscriptions=function(){function Subscriptions(consumer){this.consumer=consumer,this.subscriptions=[]}return Subscriptions.prototype.create=function(channelName,mixin){var channel,params,subscription;return params="object"==typeof(channel=channelName)?channel:{channel:channel},subscription=new ActionCable.Subscription(this.consumer,params,mixin),this.add(subscription)},Subscriptions.prototype.add=function(subscription){return this.subscriptions.push(subscription),this.consumer.ensureActiveConnection(),this.notify(subscription,"initialized"),this.sendCommand(subscription,"subscribe"),subscription},Subscriptions.prototype.remove=function(subscription){return this.forget(subscription),this.findAll(subscription.identifier).length||this.sendCommand(subscription,"unsubscribe"),subscription},Subscriptions.prototype.reject=function(identifier){var i,len,ref,results,subscription;for(results=[],i=0,len=(ref=this.findAll(identifier)).length;i<len;i++)subscription=ref[i],this.forget(subscription),this.notify(subscription,"rejected"),results.push(subscription);return results},Subscriptions.prototype.forget=function(subscription){var s;return this.subscriptions=function(){var i,len,ref,results;for(results=[],i=0,len=(ref=this.subscriptions).length;i<len;i++)(s=ref[i])!==subscription&&results.push(s);return results}.call(this),subscription},Subscriptions.prototype.findAll=function(identifier){var i,len,ref,results,s;for(results=[],i=0,len=(ref=this.subscriptions).length;i<len;i++)(s=ref[i]).identifier===identifier&&results.push(s);return results},Subscriptions.prototype.reload=function(){var i,len,ref,results,subscription;for(results=[],i=0,len=(ref=this.subscriptions).length;i<len;i++)subscription=ref[i],results.push(this.sendCommand(subscription,"subscribe"));return results},Subscriptions.prototype.notifyAll=function(argument_0){var args,callbackName,i,len,ref,results,subscription;for(callbackName=argument_0,args=2<=arguments.length?slice.call(arguments,1):[],results=[],i=0,len=(ref=this.subscriptions).length;i<len;i++)subscription=ref[i],results.push(this.notify.apply(this,[subscription,callbackName].concat(slice.call(args))));return results},Subscriptions.prototype.notify=function(argument_0,argument_1){var args,callbackName,i,len,results,subscription,subscriptions;for(subscription=argument_0,callbackName=argument_1,args=3<=arguments.length?slice.call(arguments,2):[],results=[],i=0,len=(subscriptions="string"==typeof subscription?this.findAll(subscription):[subscription]).length;i<len;i++)subscription=subscriptions[i],results.push("function"==typeof subscription[callbackName]?subscription[callbackName].apply(subscription,args):void 0);return results},Subscriptions.prototype.sendCommand=function(subscription,command){var identifier;return identifier=subscription.identifier,this.consumer.send({command:command,identifier:identifier})},Subscriptions}()}.call(this),function(){ActionCable.Subscription=function(){function Subscription(consumer,params,mixin){this.consumer=consumer,null==params&&(params={}),this.identifier=JSON.stringify(params),extend(this,mixin)}var extend;return Subscription.prototype.perform=function(action,data){return null==data&&(data={}),data.action=action,this.send(data)},Subscription.prototype.send=function(data){return this.consumer.send({command:"message",identifier:this.identifier,data:JSON.stringify(data)})},Subscription.prototype.unsubscribe=function(){return this.consumer.subscriptions.remove(this)},extend=function(object,properties){var key,value;if(null!=properties)for(key in properties)value=properties[key],object[key]=value;return object},Subscription}()}.call(this),function(){ActionCable.Consumer=function(){function Consumer(url){this.url=url,this.subscriptions=new ActionCable.Subscriptions(this),this.connection=new ActionCable.Connection(this)}return Consumer.prototype.send=function(data){return this.connection.send(data)},Consumer.prototype.connect=function(){return this.connection.open()},Consumer.prototype.disconnect=function(){return this.connection.close({allowReconnect:!1})},Consumer.prototype.ensureActiveConnection=function(){if(!this.connection.isActive())return this.connection.open()},Consumer}()}.call(this)}).call(this),"object"==typeof module&&module.exports?module.exports=ActionCable:"function"==typeof define&&define.amd&&define(ActionCable)}).call(this);